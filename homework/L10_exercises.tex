%%% License: Creative Commons Attribution Share Alike 4.0 (see https://creativecommons.org/licenses/by-sa/4.0/)


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass[a4paper]{article}

\usepackage{amssymb}
\usepackage{enumitem}
\usepackage[usenames,dvipsnames]{color}
\usepackage{fancyhdr} % Required for custom headers
\usepackage{lastpage} % Required to determine the last page for the footer
\usepackage{extramarks} % Required for headers and footers
\usepackage[usenames,dvipsnames]{color} % Required for custom colors
\usepackage{graphicx} % Required to insert images
\usepackage{listings} % Required for insertion of code
\usepackage{courier} % Required for the courier font
\usepackage[table]{xcolor}
\usepackage{amsfonts,amsmath,amsthm,parskip,setspace,url}
\usepackage[section]{placeins}
\usepackage[a4paper]{geometry}
\usepackage[USenglish]{babel}
\usepackage[utf8]{inputenc}
\usepackage{tikz}


% Margins
\topmargin=-0.45in
\evensidemargin=0in
\oddsidemargin=0in
\textwidth=6.5in
\textheight=9.0in
\headsep=0.6in

\linespread{1.1} % Line spacing



%----------------------------------------------------------------------------------------
%   FORMATTING
%----------------------------------------------------------------------------------------
% Set up the header and footer
\pagestyle{fancy}
\lhead[c]{\textbf{{\color[rgb]{.5,0,0} K{\o}benhavns\\Universitet }}} % Top left header
\chead{\textbf{{\color[rgb]{.5,0,0} \Class }}\\ \hmwkTitle  } % Top center head
\rhead{\instructor \\ \theprofessor} % Top right header
\lfoot{\lastxmark} % Bottom left footer
\cfoot{} % Bottom center footer
\rfoot{Page\ \thepage\ of\ \protect\pageref{LastPage}} % Bottom right footer
\renewcommand\headrulewidth{0.4pt} % Size of the header rule
\renewcommand\footrulewidth{0.4pt} % Size of the footer rule


% Other formatting stuff
%\setlength\parindent{12pt}
\setlength{\parskip}{5 pt}
%\theoremstyle{definition} \newtheorem{ex}{\textbf{\Large{Exercise & #}\\}}
\usepackage{titlesec}
\titleformat{\section}[hang]{\normalfont\bfseries\Large}{Problem \thesection:}{0.5em}{}




%----------------------------------------------------------------------------------------
%	NAME AND CLASS SECTION
%----------------------------------------------------------------------------------------
\newcommand{\hmwkTitle}{Exercises after Lecture 10 (M7)} % Assignment title
\newcommand{\Class}{Mechanism Design} % Course/class
\newcommand{\instructor}{Fall 2022} % TA
\newcommand{\theprofessor}{Prof. Egor Starkov} % Professor




%----------------------------------------------------------------------------------------
%   SOLUTIONS
%----------------------------------------------------------------------------------------
\newif\ifsolutions
\solutionstrue




\begin{document}

\begin{center}
		\LARGE\textbf{Exercises after Lecture 10 (M7):\\ Matching models.}
\end{center}



\section{Solve your own problem}
	%TODO: in part 4 ask to identify a deviation if it exists, not just give y/n answer
	
	This problem is meant to demonstrate the power of DA algorithm, which finds a stable matching in \emph{any} marriage market. 
	
	Consider a market with four men and four women. Come up with arbitrary preferences for all players (i.e., a ranking for each player of all players on the other side of the market and the option to stay single).
	\begin{enumerate}
		\item Find a stable matching generated by men-proposing DA algorithm.
		\item Find a stable matching generated by women-proposing DA algorithm.
		\item Are there any other stable matchings?
		\item Suppose a men-proposing DA algorithm is run. Is there a profitable deviation for any of the women -- i.e., can any woman misreport her preferences to the mechanism to improve her matching? If yes, show it; if not, explain why.
		
		(\emph{Hint: such a deviation exists if and only if you have more than one stable matching, which happens if and only if the outcomes of W-DA and M-DA algorithms are different.})
	\end{enumerate}
	
	
\ifsolutions
\section*{Solution}
	We consider a marriage market with four men, denoted
	$M=\left\{ m_{1},m_{2},m_{3},m_{4}\right\} $, and four women, denoted
	$W=\left\{ w_{1},w_{2},w_{3},w_{4}\right\} $. We assume the following
	arbitrary ordinal prefererences of men over women (and the option
	of remaining single, denoted by the name of the player himself) and
	of women over men (and the same option):
	\begin{align*}
		m_{1}:w_{1}\succ_{m_{1}}w_{2}\succ_{m_{1}}m_{1}\succ_{m_{1}}w_{3}\succ_{m_{1}}w_{4}\;\;\; & \;\;\;w_{1}:m_{4}\succ_{w_{1}}m_{3}\succ_{w_{1}}w_{1}\succ_{w_{1}}m_{2}\succ_{w_{1}}m_{1}\\
		m_{2}:w_{4}\succ_{m_{2}}w_{1}\succ_{m_{2}}w_{2}\succ_{m_{2}}m_{2}\succ_{m_{2}}w_{3}\;\;\; & \;\;\;w_{2}:m_{3}\succ_{w_{2}}m_{4}\succ_{w_{2}}w_{2}\succ_{w_{2}}m_{2}\succ_{w_{2}}m_{1}\\
		m_{3}:w_{3}\succ_{m_{3}}w_{4}\succ_{m_{3}}w_{1}\succ_{m_{3}}w_{2}\succ_{m_{3}}m_{3}\;\;\; & \;\;\;w_{3}:m_{1}\succ_{w_{3}}m_{4}\succ_{w_{3}}m_{3}\succ_{w_{3}}w_{3}\succ_{w_{3}}m_{2}\\
		m_{4}:m_{4}\succ_{m_{4}}w_{3}\succ_{m_{4}}w_{4}\succ_{m_{4}}w_{1}\succ_{m_{4}}w_{2}\;\;\; & \;\;\;w_{4}:m_{4}\succ_{w_{4}}m_{2}\succ_{w_{4}}m_{3}\succ_{w_{4}}w_{4}\succ_{w_{4}}m_{1}.
	\end{align*}
	
	\textbf{(1)} We proceed to find the matching $\mu_{MDA}:M\cup W\rightarrow M\cup W$
	generated by the men-proposing deferred acceptance algorithm. At stage
	0, all men propose to their most preferred partner (or simply opt
	to remain single). Thus, $m_{1}$ proposes to $w_{1}$, $m_{2}$ proposes
	to $w_{4}$, $m_{3}$ proposes to $w_{3}$ and $m_{4}$ opts to remain
	single. The woman $w_{1}$ has one offer, but prefers remaining single,
	so she rejects $m_{1}$, while $w_{3}$ and $w_{4}$ also have one
	offer, which they hold on to. At stage 1, all men have outstanding
	offers (or have retired from the marriage market) except $m_{1}$,
	who proposes to $w_{2}$. She also prefers remaining single to marrying
	$m_{1}$, so she rejects his offer. At stage 2, $m_{1}$ is still
	the only man without an outstanding offer. He prefers remaining single
	to marrying either of the remaining women. Therefore, matching is
	finalised at this stage. The resulting matching is
	\[
	\mu_{MDA}=\left(\left(m_{1},m_{1}\right),\left(m_{2},w_{4}\right),\left(m_{3},w_{3}\right),\left(m_{4},m_{4}\right),\left(w_{1},w_{1}\right),\left(w_{2},w_{2}\right)\right).
	\]
	
	\textbf{(2)} We now find the matching $\mu_{WDA}:M\cup W\rightarrow M\cup W$
	generated by the women-proposing deferred acceptance algorithm. At
	stage 0, all women propose to their most preferred partner. Thus,
	$w_{1}$ proposes to $m_{4}$, $w_{2}$ proposes to $m_{3}$, $w_{3}$
	proposes to $m_{1}$ and $w_{4}$ proposes to $m_{4}$. The men $m_{3}$
	and $m_{1}$ have one offer each, however $m_{1}$ prefers remaining
	single so he rejects the offer from $w_{3}$, while $m_{3}$ holds
	on to the offer from $w_{2}$. The man $m_{4}$ has two offers. However,
	he prefers remaining single and rejects both. At stage 1, $w_{2}$
	has an outstanding offer, so she does nothing. The woman $w_{1}$
	proposes to $m_{3}$, $w_{3}$ proposes to $m_{4}$ and $w_{4}$ proposes
	to $m_{2}$. The latter now has one offer, which he holds on to, while
	$m_{4}$ still prefers remaining single, so that he rejects the offer
	from $w_{3}$. Finally, $m_{3}$ has two offers, one from $w_{1}$
	and one from $w_{2}$. He prefers $w_{1}$ and holds on to her offer.
	Accordingly, he rejects $w_{2}$. At stage 2, $w_{1}$ and $w_{4}$
	have outstanding offers, so they do nothing. The woman $w_{2}$ prefers
	remaining single over her other options. She therefore exits the marriage
	market. The woman $w_{3}$ proposes to $m_{3}$ who now has two offers.
	He prefers the offer from $w_{3}$ and rejects $w_{1}$. At stage
	3, $w_{1}$ is the only woman without outstanding offers. She prefers
	remaining single to her remaining options, so no new offers are made
	and matching is finalised. The resulting matching is 
	\[
	\mu_{WDA}=\left(\left(w_{1},w_{1}\right),\left(w_{2},w_{2}\right),\left(w_{3},m_{3}\right),\left(w_{4},m_{2}\right),\left(m_{1},m_{1}\right)\left(m_{4},m_{4}\right)\right).
	\]
	
	\textbf{(3)} First, we see that the set of singles is the same in both matchings ($\mu_{WDA}$ and $\mu_{MDA}$), as expected. Then, we observe that the two matchings are in fact identical, i.e. $\mu_{WDA}=\mu_{MDA}$. Because of this, this is the unique stable matching.
	
	\textbf{(4)} We only have one stable matching, therefore if
	a men-proposing deferred acceptance algorithm is run, there is no
	profitable deviation for any of the women. 
\fi



\section{College admissions}
	%TODO: part 2 of this question needs to be more explicit -- does it allude to C-DA being C-optimal [among stable] or to DA outcomes being pareto-optimal among all players?
	
	This problem demonstrates how marriage model can be extended to allow many-to-one matchings, which turns it into a ``college admissions model''.
	
	There is a market with four students $S = \{s_1, ..., s_4\}$ and three colleges $C= \{c_1, c_2, c_3\}$. College $c_1$ can admit two students (its \emph{quota} is $q_1=2$); the remaining two colleges can admit one student each ($q_2=q_3=1$). Players' preferences (ordinal rankings, written best to worst) are given by
	\begin{align*}
		\succ_{s_1}: &\ c_3, c_1, c_2	&	\succ_{c_1}: &\ s_1, s_2, s_3, s_4
		\\
		\succ_{s_2}: &\ c_2, c_1, c_3	&	\succ_{c_2}: &\ s_1, s_2, s_3, s_4
		\\
		\succ_{s_3}: &\ c_1, c_3, c_2	&	\succ_{c_3}: &\ s_3, s_1, s_2, s_4
		\\
		\succ_{s_4}: &\ c_1, c_2, c_3
	\end{align*}
	
	Your goal is to find a stable matching in this problem. The only difference from the marriage model we considered in class is that college $c_1$ can admit \emph{two} students. The trick is to represent the two available spots in $c_1$ as two independent players which have the same preferences over students and which rank equally against other colleges among the students.
	
	In particular, consider instead a market with the same four students but now four colleges $C' = \{c_{1.1}, c_{1.2}, c_2, c_3\}$ (each with quota $q_i=1$, as in the marriage model), and preferences are given by 
	\begin{align*}
		\succ_{s_1}: &\ c_3, c_{1.1}, c_{1.2}, c_2	&	\succ_{c_{1.1}}: &\ s_1, s_2, s_3, s_4
		\\
		\succ_{s_2}: &\ c_2, c_{1.1}, c_{1.2}, c_3	&	\succ_{c_{1.2}}: &\ s_1, s_2, s_3, s_4
		\\
		\succ_{s_3}: &\ c_{1.1}, c_{1.2}, c_3, c_2	&	\succ_{c_2}: &\ s_1, s_2, s_3, s_4
		\\
		\succ_{s_4}: &\ c_{1.1}, c_{1.2}, c_2, c_3	&	\succ_{c_3}: &\ s_3, s_1, s_2, s_4
	\end{align*}
	
	\begin{enumerate}
		\item Use the college-proposing DA algorithm to find a stable matching.
		\item Matching $\mu$ generated by the C-DA algorithm is $C'$-optimal. However, there is another matching $\mu' = \{ (c_1, s_2, s_4), (c_2, s_1), (c_3, s_3) \}$ that is strictly preferred to $\mu$ by all colleges in $C$. How can you explain this contradiction?
	\end{enumerate}


\ifsolutions
\section*{Solution}
	% See proof of Thm 5.10 in RS.
	%\begin{enumerate}
	%	\item $\mu = \{ (c_1, s_3, s_4), (c_2, s_2), (c_3, s_1) \}$.
	%	\item Matching $\mu'$ is not stable (we defined $X$-optimality as being the best for $X$ among \emph{stable matchings}).
	%\end{enumerate}
	
	\textbf{(1)} We want to find the matching $\mu$ generated
	by the college-proposing deferred acceptance algorithm, where the
	two available slots in $c_{1}$ are represented as two separate colleges
	$c_{1,1}$ and $c_{1,2}$.
	\begin{itemize}
		\item  At stage 0, all colleges make an offer
		of admission to their preferred students: $c_{1,1}$, $c_{1,2}$ and
		$c_{2}$ all make offers to $s_{1}$ while $c_{3}$ makes an offer
		to $s_{3}$. The latter has got one offer, and he holds on to it.
		The student $s_{1}$ prefers the offer from $c_{1,1}$, so he rejects
		the offers from $c_{1,2}$ and $c_{2}$.
		\item  At stage 1, $c_{3}$ and
		$c_{1,1}$ have outstanding offers, so they do nothing, while $c_{1,2}$
		and $c_{2}$ both make offers to $s_{2}$, who prefers the offer from
		$c_{2}$. In consequence, she rejects the offer from $c_{1,2}$.
		\item At stage 2, $c_{1,1}$, $c_{2}$ and $c_{3}$ all have outstanding offers,
		so they do nothing. The college $c_{1,2}$ makes and offer to $s_{3}$
		who prefers this offer to the one from $c_{3}$. In consequence, he
		rejects the latter college and holds on to the offer from $c_{1,2}$.
		\item A stage 3, $c_{3}$ is the only college without outstanding offers.
		It makes an offer to $s_{1}$, who prefers this to the offer from
		$c_{1,1}$. 
		\item At stage 4, the latter is the only college without outstanding
		offers. It makes an offer of admission to $s_{2}$, who prefers what
		she already had and rejects the offer. A stage 4, $c_{1,1}$ makes
		and offer to $s_{3}$ who prefers this to the offer from $c_{1,2}$.
		He therefore rejects the latter offer and accepts the one from $c_{1,1}$.
		\item Now, at stage 5, $c_{1,2}$ is the only college without outstanding
		offers. It makes and offer to $s_{4}$, who now has one offer. She
		holds on to it. 
		\item At stage 6, all colleges have outstnading offers,
		so no new offers are made. Therefore, matching is finalised. The resulting
		matching is
		\[
		\mu=\left(\left(c_{1,1},s_{3}\right),\left(c_{1,2},s_{4}\right),\left(c_{2},s_{2}\right),\left(c_{3},s_{1}\right)\right).
		\]
	\end{itemize}
	
	\textbf{(2)} %It is in fact surprising that there is some matching that all colleges prefer to the $C'$-weakly optimal matching $\mu$. However, $\mu$ is only $C'$-weakly optimal in the sense that there can be no matching that awards \emph{all} colleges a better student in \emph{every} position than it gets in $\mu$. There can be matchings however, that like $\mu'$ award some spots better students, and other spots the same students as in $\mu$.
	C-DA matching $\mu$ is strongly Pareto-optimal for colleges among \textbf{stable} matchings. The suggested matching $\mu'$ is not stable.
\fi



\section{Matching on height}
	%Final2020, p3
	Consider the classic marriage (two sided-matching) model, with finite sets of men and women, $M$ and $W$.  Each man $m \in M$ has height $h_m$; each woman $w \in W$ has height $h_w$.  Preferences are as follows:
	
	\begin{itemize}
		\item agents prefer mates to have height closer to their own;
		\item agents strictly prefer being matched to remaining single.
	\end{itemize}
	
	Formally, the utility that man $m$ and woman $w$ get from being matched to each other is given by $u_m(w) = u_w(m) = -|h_m - h_w|$, and the utility of being single is arbitrarily low.
	
	In particular, consider a market with three men $M = \{m_1,m_2,m_3\}$ with heights $\{h_{m_1}, h_{m_2}, h_{m_3}\} = \{174,177,184\}$ and two women $W = \{w_1,w_2\}$ with heights $\{h_{w_1}, h_{w_2}\} = \{175,180\}$.
	
	\begin{enumerate}
		\item %(5pts) 
		Find the outcome of men-proposing deferred acceptance (M-DA) algorithm in this market.
		\item %(5pts) 
		Find the outcome of women-proposing deferred acceptance (W-DA) algorithm in this market.
		\item %(5pts) 
		Are there any other stable matchings? Find them or argue why none exist.
	\end{enumerate}
	Consider now an incomplete-information setting, where the players' heights are not observable to the designer (but all players know everyone's height). 
	\begin{enumerate}[resume]
		\item %(5pts) 
		Consider a game in which all player must report their heights before the W-DA algorithm is run. Show that the strategy profile where all players truthfully report their heights is not a Bayes-Nash Equilibrium of this game.
		\item %(5pts) 
		Given that all players know everyone's height, is there a mechanism that the designer can use to elicit players' true heights? (No transfers are allowed.) If yes, describe the mechanism fully and verify that it implements the truthful outcome. If not, argue why not.
	\end{enumerate}


\ifsolutions
\section*{Solution}
	\begin{enumerate}
		\item[1-2.] The answers to parts 1 and 2 are the same: under either algorithm the matches are $(m_1, w_1)$ and $(m_2, w_2)$, while $m_3$ remains single. It is not necessary to provide the derivation via DA algorithms explicitly.
		
		%\emph{Grading note} for 1 and 2: partial credit possible if student ran some steps of the algorithm correctly but arrived to a wrong answer.
		
		\setcounter{enumi}{2}
		\item Together with the lattice structure of the set of stable matchings and the fact that the outcomes of M-DA and W-DA are always the maximal and minimal elements of this lattice, the fact that the two coincide implies that the set of stable matchings is a singleton (i.e., the outcome identified in (1)-(2) is unique). Alternatively, this particular problem is simple enough to bruteforce through all possible matchings to verify that no other matchings are stable.
		
		\item If $m_3$ reports his height truthfully then he remains single, while reporting $h_{m_3} = 180$ would lead to him being matched with $w_2$ under W-DA. Alternatively, man $m_2$ also has a profitable deviation by reporting $h_{m_2} = 175$.
		
		%\emph{Grading note}: full credit for identifying one valid profitable deviation.
		
		\item Ask each player to report \emph{all} players' height. If all reports coincide, use this height profile to run M-DA/W-DA algorithm. Otherwise leave everyone unmatched (note that your mechanism \emph{must} prescribe some outcome in case of mismatching reports, otherwise players' incentives are not well defined). Truthtelling is an equilibrium of this mechanism: neither of the players matched under truthtelling want to deviate and become unmatched, and $m_3$ is indifferent between reporting truthfully and lying.
		
		Another possible correct answer is as follows. Ask each player to report all players' height. If at least $4$ out of $5$ reports coincide, use the modal heights profile to run M-DA/W-DA algorithm. Otherwise \emph{match randomly}. Note that random matching is better for $m_3$ than remaining single for sure, so $m_3$ must not be able to invoke this possibility on his own -- hence the 4/5 rule.
	\end{enumerate}
\fi


\end{document}
